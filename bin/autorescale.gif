#!/bin/sh

lol()
{
  unset -f lol
  while true
  do
    if [ -f ~/.gif ]; then
      mv -v ~/.gif ~/.gif.isrunning
      SRC=$(cat ~/.cache/source && rm ~/.cache/source)
      DEST=$(cat ~/.cache/destination && rm ~/.cache/destination)
      SIZE=$(cat ~/.cache/size && rm ~/.cache/size)
      [ -d "$DEST" ] || { echo "DEST directory doesn't exist."; mkdir -pv $DEST; }
      [ -d "$SRC" ] || { echo "SRC directory doesn't exist."; exit 1; }
      cd "$SRC"
      IFS=$'\n'; for i in *; do
        magick convert "$i" -filter box -coalesce -resize "${SIZE:-1024x768}"\! -strip -deconstruct "$DEST/$i"
      done
      rm -v ~/.gif.isrunning
    fi
    sleep 5
  done
}
lol

